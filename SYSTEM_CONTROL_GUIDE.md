# 🎮 하수구 덮개 자동 제어 시스템 - 동작 기준 가이드

## 🔧 모터 동작 설정 (업데이트됨)

### 🚀 강화된 모터 제어
- **서보 모터 각도**: 0° (열림) ↔ 180° (완전 닫힘)
- **DC 모터 속도**: 80 (이전 50에서 증가)
- **회전 시간**: 3초 (이전 1초에서 증가)
- **동작 완료 대기**: 추가 2초

### ⚙️ 모터 타입별 동작

#### 🎯 서보 모터 (권장)
```python
# 덮개 열기
servo.degree = 0    # 0도 = 완전히 열린 상태

# 덮개 닫기  
servo.degree = 180  # 180도 = 완전히 닫힌 상태
```

#### 🔄 DC 모터
```python
# 덮개 닫기
motor.speed = 80    # 80% 속도로 3초간 회전
time.sleep(3)       # 3초 동안 회전
motor.speed = 0     # 정지

# 덮개 열기
motor.speed = -80   # 80% 속도로 3초간 역방향 회전
time.sleep(3)       # 3초 동안 역방향 회전  
motor.speed = 0     # 정지
```

## 📊 자동 제어 기준

### 🚨 덮개 자동 닫기 조건
```
위험도 ≥ 70% AND 덮개가 열려있는 상태
```

**상세 조건:**
- **위험도 임계값**: 70% (기본값, 조정 가능)
- **덮개 상태**: `cover_closed = False`
- **연속 확인**: 5초마다 위험도 체크
- **네트워크 신호**: 먼저 위험 신호(1) 전송
- **모터 동작**: 네트워크 신호 후 모터 작동

### 🌊 덮개 자동 열기 조건
```
위험도 < 35% AND 덮개가 닫혀있는 상태 AND 5초 안전 확인
```

**상세 조건:**
- **안전 임계값**: 35% (위험도 임계값의 50%)
- **덮개 상태**: `cover_closed = True`
- **안전 확인**: 5초 대기 후 위험도 재확인
- **이중 검증**: 두 번 연속 안전 수준 확인
- **네트워크 신호**: 안전 신호(0) 전송 후 열기

## 🔄 동작 시퀀스

### 📈 위험 상황 (덮개 닫기)
```
1. 쓰레기 감지 → 위험도 계산
2. 위험도 ≥ 70% 달성
3. 🚨 위험 알림 출력
4. 📡 네트워크 신호 전송 (값: 1)
5. ⚙️ 모터 동작 시작
   - 서보: degree = 180
   - DC: speed = 80, 3초간 회전
6. ⏰ 2초 완료 대기
7. ✅ 덮개 닫기 완료
8. 🛡️ 안전 상태 전환
```

### 📉 안전 복구 (덮개 열기)
```
1. 위험도 지속 감소
2. 위험도 < 35% 달성
3. ⏰ 5초 안전 확인 대기
4. 🔍 위험도 재확인
5. 📡 네트워크 신호 전송 (값: 0)
6. ⚙️ 모터 동작 시작
   - 서보: degree = 0
   - DC: speed = -80, 3초간 역회전
7. ⏰ 2초 완료 대기
8. ✅ 덮개 열기 완료
9. 🌊 정상 상태 복구
```

## 🎯 위험도 계산 요소

### 📊 기본 점수 (최대 60점)
- **감지 개수**: 개당 8점 (최대 60점)
- **신뢰도 보너스**: (신뢰도 - 30%) × 30점 (최대 20점)
- **면적 보너스**: 총면적 ÷ 5000 (최대 15점)
- **쓰레기 종류 가중치**: (가중치 - 1.0) × 3점 (최대 10점)

### 🏷️ 쓰레기 종류별 가중치
- **높은 위험** (1.8배): plastic_bag, garbage_bag
- **중간 위험** (1.2배): paper, cardboard
- **낮은 위험** (0.8배): plastic_bottle, glass_bottle

### ⏱️ 시간적 요소
- **활성 감지**: 최근 8초 이내만 계산
- **자동 감소**: 감지 없으면 초당 2% 감소
- **점진적 변화**: 급격한 변화 방지 (70% 반영)

## 🛠️ 수동 제어 명령

### 💻 터미널 명령어
```bash
# 시스템 상태 확인
명령 입력> status

# 수동으로 덮개 닫기 (즉시 실행)
명령 입력> close

# 수동으로 덮개 열기 (즉시 실행)
명령 입력> open

# 위험도 임계값 변경 (예: 75%로 변경)
명령 입력> threshold 75

# 자동 모니터링 시작/중단
명령 입력> monitor
명령 입력> stop

# 프로그램 종료
명령 입력> quit
```

## 📈 실시간 모니터링

### 🌐 웹 대시보드
- **URL**: http://localhost:8000
- **실시간 위험도**: 그래프로 표시
- **덮개 상태**: 열림/닫힘 표시
- **감지 로그**: 최근 감지 기록
- **알림 이벤트**: 자동 제어 기록

### 📱 상태 표시
```
현재 위험도: 45.2% (warning)
덮개 상태: 열림 (cover_closed: False)
마지막 감지: 2초 전
네트워크 모듈: 연결됨
모터 모듈: 연결됨
```

## ⚠️ 안전 기능

### 🛡️ 다중 안전 장치
1. **네트워크 신호 우선**: 모터 동작 전 네트워크 신호 전송
2. **이중 확인**: 열기 전 5초 안전 확인
3. **수동 오버라이드**: 언제든 수동 제어 가능
4. **점진적 변화**: 급격한 위험도 변화 방지
5. **오류 복구**: 모터 오류 시 재시도

### 🔧 문제 해결
- **모터 무응답**: 수동 명령으로 테스트
- **네트워크 오류**: 직접 모터 제어로 우회
- **과도한 민감도**: threshold 값 상향 조정
- **반응 지연**: 5초 모니터링 주기 단축

## 📋 설정 최적화

### 🏙️ 도시 지역 (일반)
```python
danger_threshold = 70.0    # 표준 임계값
motor_speed = 80          # 빠른 응답
rotation_time = 3         # 충분한 동작 시간
```

### 🌊 위험 지역 (민감)
```python
danger_threshold = 60.0    # 낮은 임계값 (더 민감)
motor_speed = 80          # 빠른 응답
rotation_time = 4         # 더 긴 동작 시간
```

### 🏢 실내 테스트
```python
danger_threshold = 50.0    # 매우 낮은 임계값
motor_speed = 60          # 느린 속도
rotation_time = 2         # 짧은 동작 시간
```

이제 모터가 더 큰 동작 범위(0°↔180°)와 더 긴 회전 시간(3초)으로 확실하게 움직이며, 위험도 70% 이상에서 자동으로 닫히고 35% 이하에서 안전 확인 후 자동으로 열립니다!